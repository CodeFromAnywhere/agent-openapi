<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Chat Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
</head>

<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-4">
        <div class="flex">
            <!-- Thread list -->
            <div id="threadList" class="w-1/4 bg-white p-4 rounded-lg shadow mr-4">
                <h2 class="text-xl font-bold mb-4">Threads</h2>
                <ul id="threads" class="space-y-2"></ul>
            </div>

            <!-- Chat area -->
            <div class="w-3/4 bg-white p-4 rounded-lg shadow">
                <div id="messages" class="space-y-4 mb-4 h-[60vh] overflow-y-auto"></div>
                <form id="messageForm" class="mt-4">
                    <input type="text" id="messageInput" class="w-full p-2 border rounded"
                        placeholder="Type your message...">
                    <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Send</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000';
        // const API_BASE_URL = 'https://agent.actionschema.com';
        let agentSlug, agentToken, threadId, userAuthToken;

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            agentSlug = urlParams.get('agentSlug');
            agentToken = urlParams.get('agentToken');
            threadId = urlParams.get('threadId');

            userAuthToken = localStorage.getItem('userAuthToken');
            if (!userAuthToken) {
                userAuthToken = window.prompt("Please enter your user auth token:");
                localStorage.setItem('userAuthToken', userAuthToken);
            }

            await fetchAgentUser();
            if (threadId) {
                await fetchThread(threadId);
            }
        }

        async function fetchAgentUser() {
            try {
                const response = await axios.post(`${API_BASE_URL}/api/readAgentUser`, {}, {
                    headers: {
                        'X_AGENT_AUTH_TOKEN': agentToken,
                        'Authorization': `Bearer ${userAuthToken}`
                    }
                });
                const threads = response.data.threadIds;
                renderThreads(threads);
            } catch (error) {
                console.error('Error fetching agent user:', error);
            }
        }

        function renderThreads(threads) {
            const threadsList = document.getElementById('threads');
            threadsList.innerHTML = '';
            threads.forEach(thread => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="?agentSlug=${agentSlug}&agentToken=${agentToken}&threadId=${thread}" class="text-blue-500 hover:underline">${thread}</a>`;
                threadsList.appendChild(li);
            });
        }

        async function fetchThread(threadId) {
            try {
                const response = await axios.post(`${API_BASE_URL}/api/readAgentUserThread`, { threadId }, {
                    headers: {
                        'X_AGENT_AUTH_TOKEN': agentToken,
                        'Authorization': `Bearer ${userAuthToken}`
                    }
                });
                renderMessages(response.data.messages);
            } catch (error) {
                console.error('Error fetching thread:', error);
            }
        }

        function renderMessages(messages) {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            messages.forEach(message => {
                const div = document.createElement('div');
                div.className = `p-2 rounded ${message.role === 'user' ? 'bg-blue-100' : 'bg-gray-100'}`;
                div.textContent = message.content;
                messagesContainer.appendChild(div);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage(message) {
            try {
                const response = await axios.post(`${API_BASE_URL}/${agentSlug}/message`, {
                    message,
                    threadId
                }, {
                    headers: {
                        'X_AGENT_AUTH_TOKEN': agentToken,
                        'Authorization': `Bearer ${userAuthToken}`
                    }
                });

                const newMessages = response.data.messages;
                renderMessages(newMessages);

                if (response.data.threadId) {
                    threadId = response.data.threadId;
                    history.pushState(null, '', `?agentSlug=${agentSlug}&agentToken=${agentToken}&threadId=${threadId}`);
                }

                if (response.data.newAuthToken) {
                    userAuthToken = response.data.newAuthToken;
                    localStorage.setItem('userAuthToken', userAuthToken);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (message) {
                await sendMessage(message);
                messageInput.value = '';
            }
        });

        init();
    </script>
</body>

</html>